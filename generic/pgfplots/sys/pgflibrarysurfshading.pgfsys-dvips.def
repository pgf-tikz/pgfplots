%--------------------------------------------
% $Header: /cvsroot/pgfplots/pgfplots/generic/pgfplots/libs/pgflibrarysurfshading.code.tex,v 1.16 2009/03/10 21:34:37 ludewich Exp $
%
% Package pgfplots
%
% Provides a user-friendly interface to create function plots (normal
% plots, semi-logplots and double-logplots).
% 
% It is based on Till Tantau's PGF package.
%
% Copyright 2007/2008 by Christian Feuers√§nger.
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
%--------------------------------------------


\def\pgfplotslibrarysurf@initstream{%
	\if\pgfplotslibrarysurf@bytespercoordinate4%
		\pgfplots@warning{************** The generated postscript file may not be compatible with all viewers. Consider using \string\pgfplotsset{surf shading/precision=postscript} for improved compatibility. Or: convert it to pdf, that will work correctly. **************}%
	\fi
	% binary doesn't work due to limitations of DVI.
	% We NEED an ASCII encoding.
	%
	%\def\pgfplotslibrarysurf@binarystream@len{0}%
	%\pgfkeysalso{/pgfplots/bin/ASCII85 encoding}%
	\def\pgfplotslibrarysurf@filter@encode{ASCIIHexEncode}%
	\def\pgfplotslibrarysurf@filter@decode{ASCIIHexDecode}%
}%
%--------------------------------------------------
% \def\pgfplotslibrarysurf@advancestreamlen#1{%
% 	\begingroup
% 		\c@pgf@counta=\pgfplotslibrarysurf@binarystream@len\relax
% 		\advance\c@pgf@counta by#1
% 		\xdef\pgfplots@glob@TMPa{\the\c@pgf@counta}%
% 	\endgroup
% 	\let\pgfplotslibrarysurf@binarystream@len=\pgfplots@glob@TMPa
% }%
%-------------------------------------------------- 

% The lowlevel call for surface shadings. It uses a pattern type 2
% dictionary as fill color and has thus several things to do. This is
% a little bit more complicated than using the '/sh' operator (as
% other pgf shadings do): the surface shading must be positioned
% exactly at the requested coordinates, otherwise it is quite useless.
%
% Since shadings are *not* affected by changes in the canvas
% transformation matrix (shifts, rotations etc), it is necessary to
% pack the shading into a separate xform object which is then rotated
% and translated correctly. 
%
% There is just one more transformation necessary: the shift inside of
% the xform. This shift is done using changes in the canvas
% transformation matrix and it is UNDONE in the /Matrix argument of
% the pattern dictionary. This last step can't be done with the /sh
% operator which is why I am using pattern dictionaries.
\def\pgfplotslibrarysurfdraw{%
	%\pgfplots@error{Sorry, surfshading (shader=interp) is NOT available for the selected driver `\pgfsysdriver'.}%
	\begingroup
%	\setbox\pgfutil@tempboxa=\hbox{%
		\pgfpicture
		\pgfplotssys@do@surfshading@fillpaths\pgfplots@loc@TMPa%
		\global\let\pgfplots@glob@TMPa=\pgfplots@loc@TMPa
		\pgfpathrectanglecorners
			{\pgfplotslibrarysurf@corner@sw}
			{\pgfplotslibrarysurf@corner@ne}%
		\pgfusepath{fill}%
		\endpgfpicture
%	}%
%	\pdfxform resources{
%		/Pattern << \pgfplots@glob@TMPa >> % write the pattern resource dictionary
%	}\pgfutil@tempboxa
	\leavevmode
%	\pdfrefxform\pdflastxform
	\endgroup
}

% To be used inside of a pgfpicture.
%
% #1: a macro name. The contents of this macro needs to be written
% into the pdf pattern dictionary contained in the pdf resources of
% the current context. The current context is either the current page
% or an xform object.
%
%
\def\pgfplotssys@do@surfshading@fillpaths#1{%
%http://www.ghostscript.com/pipermail/gs-devel/2002-September/005763.html
%http://www.tek-tips.com/viewthread.cfm?qid=1183719&page=4
	%--------------------------------------------------
	% \edef\pgf@sys@marshal{%
	% 	\noexpand\pgfutil@insertatbegincurrentpage{\noexpand\pgfsys@outerinvoke{
	% 		save true setglobal globaldict begin /pgfpat#1
	% 		{
	% 			/Pattern
	% 			setcolorspace
	% 			gsave
	% 			initgraphics
	% 			<<
	% 				/Type /Pattern
	% 				/PatternType 2
	% 			>>
	% 			matrix
	% 			makepattern
	% 			grestore
	% 			setcolor
	% 		} bind def end restore
	% 	}}% <<
	% }%
	%-------------------------------------------------- 
	\pgf@process{\pgfpointdiff{\pgfplotslibrarysurf@corner@sw}{\pgfkeysvalueof{/pgfplots/surf shading/anchor}}}%
	\pgf@sys@bp@correct\pgf@x%
	\pgf@sys@bp@correct\pgf@y%
	\pgfsys@invoke{%
		<<	
			%/Type /Pattern
			/PatternType 2
			/Shading
			<<
				/ShadingType 5
				/BitsPerCoordinate \pgfplotslibrarysurf@bitspercoordinate\space
				/BitsPerComponent 16 % FIXME : 32 CAN'T work because 24 (or 16?) is maximum! need better impl for ASCII85Decode
				/VerticesPerRow \pgfkeysvalueof{/pgfplots/surf shading/cols}
				/ColorSpace /DeviceRGB
				/Decode [\pgfplotslibrarysurf@decode]
				/Function \pgfkeysvalueof{/pgfplots/surf shading/colormap}
				/DataSource	
					currentfile 
						%<< /EODCount \pgfplotslibrarysurf@binarystream@len\space /EODString () >>  /SubFileDecode filter
						%/ASCII85Decode filter
						/ASCIIHexDecode filter
						/ReusableStreamDecode filter
							\pgfplotslibrarysurf@binarystream
							%\csname pgfp@bin@126\endcsname% tilde ~>
							> %\space
			>>
		>> [ 1 0 0 1 0 0 ] makepattern setpattern
%		>> [ 1 0 0 1 \pgf@sys@tonumber\pgf@x\space \pgf@sys@tonumber\pgf@y ] makepattern setpattern
		% 'setpattern' is a shortcut for changing the colorspace and
		% the color to pattern.
		%/Matrix [1 0 0 1 \pgf@sys@tonumber\pgf@x\space \pgf@sys@tonumber\pgf@y] %226.533 518.141] 
	}%
%	\begingroup
%	\immediate\openout13=binarydata.bin
%	\immediate\write13{\pgfplotslibrarysurf@binarystream}%
%	\immediate\closeout13
%	\endgroup
	%--------------------------------------------------
	% \edef\pgfplots@loc@TMPa{\the\pdflastobj}%
	% \immediate\pdfobj {<<
	% 	/PatternType 2
	%-------------------------------------------------- 
%		/Matrix [\pgf@pt@aa\space\pgf@pt@ab\space\pgf@pt@ba\space\pgf@pt@bb\space\pgf@sys@tonumber\pgf@pt@x\space\pgf@sys@tonumber\pgf@pt@y]
	%--------------------------------------------------
	% 	% FIXME: INCORPORATE TIKZ CM
	% 	%--------------------------------------------------
	% 	% /ExtGState 
	% 	% 	<<
	% 	% 		/LW 2
	% 	% 		/OP true
	% 	% 		/OPM 1
	% 	% 	>>
	% 	%-------------------------------------------------- 
	% 	/Shading \pgfplots@loc@TMPa\space 0 R 
	% >>}%
	% \edef#1{%
	% 	/pgfpatPlotsurface\pgfplotslibrarysurf@count\space \the\pdflastobj\space 0 R
	% }%
	% \pgfsys@setpatterncolored{Plotsurface\pgfplotslibrarysurf@count}%
	% \pgfplotsutil@advancestringcounter@global\pgfplotslibrarysurf@count
	%-------------------------------------------------- 
}

\endinput
% vi: ft=tex
